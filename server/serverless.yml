service: insider

plugins:
  - serverless-offline
  - serverless-s3-sync
  - serverless-domain-manager
  - serverless-python-requirements

package:
  exclude:
    - .vscode/**
    - venv/**
    - env/**
    - stock_screener_py/venv/**
    - stock_screener_py/env/**
    - stock_screener_py/__pycache__/**
    - bin/**
    - lib/**
    - test/**

provider:
  name: aws
  runtime: python3.8
  stage: ${opt:stage, 'dev'}
  region: eu-central-1
  deploymentBucket:
    name: learning-serverless
  iamRoleStatements:
  - Effect: Allow
    Resource: "*"
    Action:
    - s3:*
    - firehose:*
    - glue:*
    - lambda:InvokeFunction
  environment:
    select_bucket: ${self:custom.select_bucket}
    deliveryStreamDE: ${self:custom.deliveryStreamDE}
    insiderDBGlue: ${self:custom.insiderDBGlue}

custom:
  pythonRequirements:
    dockerizePip: non-linux
  serviceId: ${self:service}-${self:provider.stage}
  select_bucket: myinsiderposition-${self:provider.stage}
  deliveryStreamDE: insider-de-stream-${self:provider.stage}
  insiderDBGlue: insider-de-database-glue-${self:provider.stage}
  optionsCollectSqs: options-collect-sqs-${self:provider.stage}
  guiBucketName: gui-${self:custom.serviceId}
  siteName: myinsiderposition.com
  aliasHostedZoneId: Z21DNDUVLTQW6Q
  aliasDNSName: s3-website.eu-central-1.amazonaws.com
  s3Sync:
  - bucketName: ${self:custom.siteName}
    localDir: ../insider-gui/build
  customDomain:
    domainName: api.myinsiderposition.com
    basePath: ''
    certificateName: '*.myinsiderposition.com'
    stage: ${self:provider.stage}
    endpointType: 'regional'
    createRoute53Record: true

functions:
  createS3:
    runtime: nodejs12.x
    handler: s3select.create
    cors: true
    timeout: 300
    memorySize: 256
    events:
    - schedule: rate(2 hours)
    - http:
        path: create
        method: get
  selectS3Trades:
    runtime: nodejs12.x
    handler: s3select.tradesDE
    events:
    - http:
        cors: true
        path: trades/de
        method: get
  selectS3Companies:
    runtime: nodejs12.x
    handler: s3select.companiesDE
    memorySize: 256
    events:
    - http:
        cors: true
        path: companies/de
        method: get
  selectCompaniesChartHistoricPrices:
    runtime: nodejs12.x
    handler: s3select.companyHistoricalChartData
    memorySize: 256
    events:
    - http:
        cors: true
        path: chart/historical
        method: get
  selectS3Insiders:
    runtime: nodejs12.x
    handler: s3select.insidersDE
    memorySize: 256
    events:
    - http:
        cors: true
        path: insiders/de
        method: get
  optionalStocks:
    runtime: nodejs12.x
    handler: s3select.optionalStocks
    memorySize: 512
    events:
    - http:
        cors: true
        path: stocks/optionable
        method: get
  optionalStock:
    runtime: nodejs12.x
    handler: s3select.optionalStock
    memorySize: 256
    events:
    - http:
        cors: true
        path: stock/optionable/{ticker}
        method: get
  putToStream:
    runtime: nodejs12.x
    handler: fhController.putToStream
    timeout: 300
    events:
    - http:
        path: put
        method: get
  firehoseEvents:
    runtime: nodejs12.x
    handler: firehoseEvents.handler
    events:
      - s3:
          bucket: ${self:custom.select_bucket}
          event: s3:ObjectCreated:*
  glueCustomResource:
    runtime: nodejs12.x
    handler: glueCustomResource.handler
  collect_optional_stocks:
    handler: stock_screener_py/stock_screener.save_all_optionable
    timeout: 900
    memorySize: 256
    events:
      - schedule: rate(7 days)
      #- schedule: cron(0/15 * * * MON-FRI *)
  update_all_proxies:
    runtime: nodejs12.x
    handler: s3select.updateAllProxies
    timeout: 900
    memorySize: 256
    events:
      - schedule: rate(15 minutes)
  update_worked_proxies:
    handler: stock_screener_py/workedProxyService.uploadWorkedProxies
    timeout: 900
    memorySize: 2048
    events:
      - schedule: rate(3 hours)
  collect_stocks:
    handler: stock_screener_py/stock_screener.save_all
    timeout: 900
    memorySize: 512
  get_all_proxies:
    runtime: nodejs12.x
    handler: s3select.getAllProxies
    timeout: 900
    memorySize: 256
  get_worked_proxies:
    runtime: nodejs12.x
    handler: s3select.getWorkedProxies
    timeout: 900
    memorySize: 256
  optionsCollectSqs:
    runtime: nodejs12.x
    handler: sqsEvents.optionsCollectSqs
    timeout: 30
    memorySize: 256
    events:
      - sqs:
          arn:
            Fn::GetAtt:
              - OptionsCollectSqs
              - Arn

resources:
  Resources:
    InsiderDeKinesisFirehose:
      Type: AWS::KinesisFirehose::DeliveryStream
      Properties:
        DeliveryStreamName: ${self:custom.deliveryStreamDE}
        S3DestinationConfiguration:
          BucketARN:
            Fn::Join:
            - ''
            - - 'arn:aws:s3:::'
              - Ref: S3BucketMyinsiderposition${self:provider.stage}
          BufferingHints:
            IntervalInSeconds: "60"
            SizeInMBs: "1"
          CompressionFormat: "GZIP"
          Prefix: "DE/"
          RoleARN:
            Fn::GetAtt: [ FirehoseToS3Role, Arn ]
    FirehoseToS3Role:
      Type: AWS::IAM::Role
      Properties:
        RoleName: FirehoseToS3Role
        AssumeRolePolicyDocument:
          Statement:
          - Effect: Allow
            Principal:
              Service:
              - firehose.amazonaws.com
            Action:
            - sts:AssumeRole
        Policies:
        - PolicyName: FirehoseToS3Policy
          PolicyDocument:
            Statement:
            - Effect: Allow
              Action:
              - s3:AbortMultipartUpload
              - s3:GetBucketLocation
              - s3:GetObject
              - s3:ListBucket
              - s3:ListBucketMultipartUploads
              - s3:PutObject
              - firehose:PutRecord
              Resource: '*'
    GlueCustomResources:
      Type: Custom::GlueCustomResource
      Properties:
        ServiceToken:
          Fn::GetAtt: [GlueCustomResourceLambdaFunction, Arn]
    InsiderStaticSite:
      Type: AWS::S3::Bucket
      Properties:
        AccessControl: PublicRead
        BucketName: ${self:custom.siteName}
        WebsiteConfiguration:
          IndexDocument: index.html
    StaticSiteS3BucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket:
          Ref: InsiderStaticSite
        PolicyDocument:
          Statement:
          - Sid: PublicReadGetObject
            Effect: Allow
            Principal: "*"
            Action:
            - s3:GetObject
            Resource:
              Fn::Join: [
                "", [
                "arn:aws:s3:::",
                {
                  "Ref": "InsiderStaticSite"
                },
                "/*"
              ]
              ]
    OptionsCollectSqs:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:custom.optionsCollectSqs}
#    DnsRecord:
#      Type: "AWS::Route53::RecordSet"
#      Properties:
#        AliasTarget:
#          DNSName: ${self:custom.aliasDNSName}
#          HostedZoneId: ${self:custom.aliasHostedZoneId}
#        HostedZoneName: ${self:custom.siteName}.
#        Name:
#          Ref: InsiderStaticSite
#        Type: 'A'
